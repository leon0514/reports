name: 定时发送新周报

on:
  workflow_dispatch: {}

jobs:
  check-and-send:
    runs-on: ubuntu-latest
    steps:
      # --- 步骤 1: 拉取代码 ---
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # --- 步骤 2: 检查是否有新周报 & 计算日期 & 解析收件人 ---
      - name: Check for recent updates and parse recipients
        id: check_date
        run: |
          # 配置：3天内修改过的文件算“新周报”
          MAX_AGE_SECONDS=259200
          REPORT_DIR="reports"
          
          echo "正在检查目录: $REPORT_DIR"
          LATEST_FILE=$(ls -t $REPORT_DIR/*.md 2>/dev/null | head -n 1)
          
          if [ -z "$LATEST_FILE" ]; then
            echo "错误：未找到 Markdown 文件"
            echo "should_send=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 保存文件名供后面使用
          echo "LATEST_FILE=$LATEST_FILE" >> $GITHUB_ENV
          
          # --- 新增：从 Markdown 文件中解析收件人和抄送人 ---
          # 格式: <!-- to: name@example.com --> 或 <!-- cc: name@example.com -->
          MAIL_TO=$(grep -i "<!-- to:" "$LATEST_FILE" | sed -e 's/<!-- to: *//' -e 's/ *-->//' | tr -d '\r')
          MAIL_CC=$(grep -i "<!-- cc:" "$LATEST_FILE" | sed -e 's/<!-- cc: *//' -e 's/ *-->//' | tr -d '\r')
          
          if [ -z "$MAIL_TO" ]; then
            echo "❌ 错误：在 $LATEST_FILE 中未找到收件人信息。请确保文件包含 '<!-- to: xxx@xxx.com -->' 格式的注释。"
            echo "should_send=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "解析出的收件人: $MAIL_TO"
          echo "MAIL_TO=$MAIL_TO" >> $GITHUB_ENV
          
          if [ -n "$MAIL_CC" ]; then
            echo "解析出的抄送人: $MAIL_CC"
            echo "MAIL_CC=$MAIL_CC" >> $GITHUB_ENV
          else
            echo "未找到抄送人信息，将不进行抄送。"
            echo "MAIL_CC=" >> $GITHUB_ENV # 确保CC为空
          fi

          # --- 检查文件是否为新文件 ---
          FILE_COMMIT_TIME=$(git log -1 --format=%ct "$LATEST_FILE")
          CURRENT_TIME=$(date +%s)
          DIFF=$((CURRENT_TIME - FILE_COMMIT_TIME))
          
          if [ $DIFF -lt $MAX_AGE_SECONDS ]; then
            echo "✅ 发现新周报: $LATEST_FILE"
            echo "should_send=true" >> $GITHUB_OUTPUT
            
            # --- 日期计算逻辑 ---
            START_DATE=$(date -d "$(date +%u) days ago + 1 day" +'%Y年%m月%d日')
            END_DATE=$(date -d "$(date +%u) days ago + 5 days" +'%m月%d日')
            
            echo "CURRENT_DATE=${START_DATE}~${END_DATE}" >> $GITHUB_ENV
            echo "计算出的日期范围: ${START_DATE}~${END_DATE}"
          else
            echo "⛔ 文件太旧，本周未更新，跳过发送。"
            echo "should_send=false" >> $GITHUB_OUTPUT
          fi

      # --- 步骤 3: 准备 Python 环境 ---
      - name: Set up Python
        if: steps.check_date.outputs.should_send == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # --- 步骤 4: 生成 Python 转换脚本并运行 ---
      - name: Generate and Run Converter
        if: steps.check_date.outputs.should_send == 'true'
        run: |
          # 注意：这里的 'EOF' 已被移除，以允许表达式求值
          cat << EOF > convert.py
          import sys, re
          
          def parse_markdown(file_path):
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
              except Exception as e:
                  print(f"Error: {e}")
                  sys.exit(1)

              def get_section(title):
                  pattern = re.compile(rf'### {title}\s*(.*?)\s*(?=###|$)', re.DOTALL)
                  match = pattern.search(content)
                  if match:
                      lines = [line.strip() for line in match.group(1).split('\n') if line.strip() and not line.strip().startswith('<!--')]
                      return "".join([f'<div style="margin-bottom:4px;">{l}</div>' for l in lines])
                  return "暂无内容"

              title_match = re.search(r'^#\s+(.*)', content, re.MULTILINE)
              report_title = title_match.group(1).strip() if title_match else "周报"

              return {
                  "title": report_title,
                  "done": get_section("本周完成情况"),
                  "plan": get_section("下周工作计划"),
                  "help": get_section("需协调事项"),
                  "other": get_section("其他问题和建议")
              }

          def generate_html(data):
              return f"""
              <!DOCTYPE html>
              <html><body>
              <table border="1" cellspacing="0" cellpadding="0" style="width:100%;max-width:800px;border-collapse:collapse;font-family:'Microsoft YaHei',Arial,sans-serif;font-size:14px;color:#333;">
                  <tr style="background-color:#E7E6E6;"><td colspan="4" style="padding:15px;text-align:center;font-weight:bold;font-size:16px;border:1px solid #999;">AI应用研发部 - ${{ secrets.USER }} 【AI算法工程师】 - {data['title']}</td></tr>
                  <tr style="background-color:#FFFF00;font-weight:bold;">
                      <td style="width:10%;background-color:#fff;border:1px solid #999;border-right:none;"></td>
                      <td style="width:30%;padding:10px;border:1px solid #999;">本周完成情况</td>
                      <td style="width:30%;padding:10px;border:1px solid #999;">下周工作计划</td>
                      <td style="width:30%;padding:10px;border:1px solid #999;">需协调事项</td>
                  </tr>
                  <tr>
                      <td style="background-color:#f9f9f9;font-weight:bold;text-align:center;padding:10px;border:1px solid #999;">内容描述</td>
                      <td style="padding:10px;border:1px solid #999;vertical-align:top;height:150px;">{data['done']}</td>
                      <td style="padding:10px;border:1px solid #999;vertical-align:top;">{data['plan']}</td>
                      <td style="padding:10px;border:1px solid #999;vertical-align:top;">{data['help']}</td>
                  </tr>
                  <tr>
                      <td style="background-color:#f9f9f9;font-weight:bold;text-align:center;padding:10px;border:1px solid #999;">其他问题<br>和建议</td>
                      <td colspan="3" style="padding:10px;border:1px solid #999;">{data['other']}</td>
                  </tr>
              </table>
              </body></html>
              """

          if __name__ == "__main__":
              data = parse_markdown(sys.argv[1])
              print(generate_html(data))
          EOF
          
          # 运行脚本生成 HTML
          echo "正在转换文件: $LATEST_FILE"
          python convert.py "$LATEST_FILE" > email_body.html
          
          # 写入环境变量
          echo "HTML_BODY<<ENV_END" >> $GITHUB_ENV
          cat email_body.html >> $GITHUB_ENV
          echo "ENV_END" >> $GITHUB_ENV

      # --- 步骤 5: 发送邮件 ---
      - name: Send mail
        if: steps.check_date.outputs.should_send == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qiye.aliyun.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "周报 - ${{ env.CURRENT_DATE }} - ${{ secrets.USER}}"
          
          # 邮件正文 (HTML)
          html_body: ${{ env.HTML_BODY }}
          
          # 收件人与抄送 (从步骤2中获取)
          to: ${{ env.MAIL_TO }}
          cc: ${{ env.MAIL_CC }}
          from: "耀安科技AI应用研发部算法 ${{ secrets.USER }}"
          secure: true